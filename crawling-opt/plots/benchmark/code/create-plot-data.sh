#! /usr/bin/env bash

# Parse the output generated by the benchmarking scripts
# and generate a data that can be processed by the plotting scripts.

# $1 -> Path to the input directory
# $2 -> Path to the output directory


# parse CPU data
echo usage time scale > $2/cpu.p
ls $1 | while read scale; do cat $1/$scale/cpu_profile | grep -v usage | awk -F',' -v scale=$scale '{print $1,$2,scale}' ; done >> $2/cpu.p
echo Done parsing CPU data

#parse network data
echo usage time scale > $2/nw.p
ls  $1 | while read scale; do cat $1/$scale/nw_profile | grep "Total send and receive rate" | awk -v scale=$scale -v t=0 '{print $6,t,scale;t+=2}' ; done | grep -v Kb | sed 's/Mb//g' >> $2/nw.p
echo Done parsing NW data

#parse disk data
echo usage time scale > $2/disk.p
ls $1 | while read scale; do cat $1/$scale/disk_profile | grep sda | head -n 150 | awk -v scale=$scale -v t=0 '{print ($3+$4)*8/1000,t,scale;t+=1}' ; done >> $2/disk.p
echo Done parsing disk data

#generate all plots
./cpu.r $2/cpu.p $2/cpu.png
./nw.r $2/nw.p $2/nw.png
./disk.r $2/disk.p $2/disk.png